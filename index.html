<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Image Recognition</title>

<!-- FIXED CDN (WAJIB) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

<style>
body { font-family: Arial; text-align: center; background: #f4f4f4; padding: 20px; }
.box { background: #fff; padding: 15px; max-width: 360px; margin: auto; border-radius: 8px; }
button, input { margin: 5px; }
canvas, img { width: 100%; margin-top: 10px; border-radius: 6px; }
</style>
</head>

<body>

<div class="box">
    <h3>Image Recognition</h3>

    <button id="camBtn" disabled>ðŸ“· Kamera</button>
    <input type="file" accept="image/*" id="fileInput">

    <div id="view"></div>
    <div id="result"></div>
</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/NWKfrLufm/";

let model, webcam, rafId;

// LOAD MODEL SETELAH LIBRARY SIAP
async function loadModel() {
    if (typeof tmImage === "undefined") {
        alert("Library tmImage gagal dimuat");
        return;
    }

    model = await tmImage.load(
        MODEL_URL + "model.json",
        MODEL_URL + "metadata.json"
    );

    document.getElementById("camBtn").disabled = false;
}
loadModel();

// CAMERA MODE
document.getElementById("camBtn").onclick = async () => {
    stopAll();

    try {
        webcam = new tmImage.Webcam(224, 224, false);
        await webcam.setup();
        await webcam.play();

        const view = document.getElementById("view");
        view.innerHTML = "";
        view.appendChild(webcam.canvas);

        loop();
    } catch (e) {
        alert("Kamera tidak bisa dibuka");
        console.error(e);
    }
};

async function loop() {
    webcam.update();
    await predict(webcam.canvas);
    rafId = requestAnimationFrame(loop);
}

// UPLOAD MODE
document.getElementById("fileInput").onchange = e => {
    stopAll();

    const img = document.createElement("img");
    img.src = URL.createObjectURL(e.target.files[0]);

    const view = document.getElementById("view");
    view.innerHTML = "";
    view.appendChild(img);

    img.onload = () => predict(img);
};

// PREDICT
async function predict(src) {
    const preds = await model.predict(src);
    const best = preds.reduce((a,b)=>a.probability>b.probability?a:b);

    document.getElementById("result").innerHTML =
        `<b>${best.className}</b> (${(best.probability*100).toFixed(2)}%)`;
}

// STOP
function stopAll() {
    if (webcam) webcam.stop();
    cancelAnimationFrame(rafId);
    document.getElementById("result").innerHTML = "";
}
</script>

</body>
</html>
